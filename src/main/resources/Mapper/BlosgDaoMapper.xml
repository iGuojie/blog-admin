<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yu.blog.dao.BlogsDao">

    <select id="selectAllBlogs" resultType="com.yu.blog.vo.BlogCovers">
        SELECT
            b.id   AS id,
            b.name AS name,
            b.created_time AS createdTime,
            b.abstracts AS abstracts,
            COALESCE(
                    img.image_url,
                    REGEXP_SUBSTR(
                            b.content,
                            'https://[^[:space:]"''&lt;&gt;()]+[.](png|jpg)',
                            1,
                            1,
                            'i'
                    )
            ) AS imageUrl,
            (SELECT c.name
             FROM category_blogs cb
             LEFT JOIN category c ON cb.category_id = c.id
             WHERE cb.blog_id = b.id
             LIMIT 1) AS category,
            GROUP_CONCAT(DISTINCT l.name SEPARATOR ',') AS labelsStr
        FROM blogs b
                 LEFT JOIN main_image AS img ON b.id = img.blog_id
                 LEFT JOIN label_blogs AS lb ON b.id = lb.blog_id
                 LEFT JOIN label AS l ON lb.label_id = l.id
        <where>
            <if test="keyword != null and keyword != ''">
                AND (b.name LIKE CONCAT('%', #{keyword}, '%')
                OR b.abstracts LIKE CONCAT('%', #{keyword}, '%')
                OR b.content LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="categoryId != null and categoryId != -1">
                AND EXISTS (
                    SELECT 1 FROM category_blogs cb2
                    WHERE cb2.blog_id = b.id
                    AND cb2.category_id = #{categoryId}
                )
            </if>
            <if test="labelId != null and labelId != -1">
                AND EXISTS (
                    SELECT 1 FROM label_blogs lb2
                    WHERE lb2.blog_id = b.id
                    AND lb2.label_id = #{labelId}
                )
            </if>
        </where>
        GROUP BY b.id, b.name, b.created_time, b.abstracts, img.image_url, b.content
        ORDER BY b.created_time DESC
</select>

</mapper>